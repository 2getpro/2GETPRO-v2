# Production Checklist

## Обзор

Этот чеклист поможет убедиться, что система готова к продакшн развертыванию.

## Безопасность

### Секреты и учетные данные

- [ ] Все секреты хранятся в переменных окружения
- [ ] Используются сильные пароли (минимум 16 символов)
- [ ] `BOT_TOKEN` защищен и не раскрыт
- [ ] `POSTGRES_PASSWORD` уникален и сложен
- [ ] `REDIS_PASSWORD` установлен
- [ ] API ключи платежных систем корректны
- [ ] `PANEL_WEBHOOK_SECRET` установлен
- [ ] `TRIBUTE_API_KEY` установлен (если используется)
- [ ] Секреты не закоммичены в Git

### Сетевая безопасность

- [ ] Firewall настроен (только необходимые порты открыты)
- [ ] SSL/TLS сертификаты установлены
- [ ] HTTPS принудительно для всех webhook'ов
- [ ] Rate limiting включен (`RATE_LIMIT_ENABLED=true`)
- [ ] Webhook валидация включена (`WEBHOOK_VALIDATION_ENABLED=true`)
- [ ] PostgreSQL доступен только из внутренней сети
- [ ] Redis доступен только из внутренней сети

### Аутентификация и авторизация

- [ ] `ADMIN_IDS` корректно настроены
- [ ] Доступ к админ-панели ограничен
- [ ] Доступ к Grafana защищен паролем
- [ ] Доступ к Prometheus ограничен

## Конфигурация

### Обязательные параметры

- [ ] `BOT_TOKEN` установлен
- [ ] `ADMIN_IDS` содержит хотя бы один ID
- [ ] `POSTGRES_*` параметры настроены
- [ ] `PANEL_API_URL` и `PANEL_API_KEY` установлены
- [ ] `WEBHOOK_BASE_URL` указывает на продакшн домен
- [ ] Хотя бы одна платежная система настроена

### Платежные системы

- [ ] YooKassa: `YOOKASSA_SHOP_ID` и `YOOKASSA_SECRET_KEY`
- [ ] CryptoPay: `CRYPTOPAY_TOKEN`
- [ ] FreeKassa: `FREEKASSA_MERCHANT_ID` и ключи
- [ ] Tribute: `TRIBUTE_API_KEY`
- [ ] Webhook URL'ы настроены в панелях провайдеров
- [ ] Тестовые платежи проведены успешно

### Цены и тарифы

- [ ] Цены установлены для всех периодов
- [ ] `RUB_PRICE_*` корректны
- [ ] `STARS_PRICE_*` корректны (если используется)
- [ ] `TRIBUTE_LINK_*` корректны (если используется)
- [ ] Триал настроен (`TRIAL_DURATION_DAYS`, `TRIAL_TRAFFIC_LIMIT_GB`)

### Реферальная программа

- [ ] `REFERRAL_BONUS_DAYS_*` настроены
- [ ] `REFEREE_BONUS_DAYS_*` настроены
- [ ] `REFERRAL_ONE_BONUS_PER_REFEREE` установлен

## Инфраструктура

### База данных

- [ ] PostgreSQL 15+ установлен
- [ ] Регулярные бэкапы настроены
- [ ] Retention policy определена
- [ ] Тестовое восстановление из бэкапа проведено
- [ ] Индексы созданы
- [ ] Миграции применены (`alembic upgrade head`)
- [ ] Connection pooling настроен

### Redis

- [ ] Redis 7+ установлен
- [ ] Persistence настроен (RDB или AOF)
- [ ] Maxmemory policy установлена
- [ ] Мониторинг памяти настроен

### Веб-сервер

- [ ] Nginx/Traefik настроен как reverse proxy
- [ ] SSL сертификаты установлены и автообновляются
- [ ] Gzip compression включен
- [ ] Request timeout настроен
- [ ] Client max body size установлен

## Мониторинг

### Prometheus

- [ ] Prometheus запущен и собирает метрики
- [ ] Retention period настроен
- [ ] Алерты настроены для критических метрик
- [ ] Дашборды созданы

### Grafana

- [ ] Grafana установлена
- [ ] Datasource (Prometheus) подключен
- [ ] Дашборды импортированы
- [ ] Алерты настроены
- [ ] Уведомления настроены (email/Telegram)

### Sentry

- [ ] `SENTRY_DSN` настроен
- [ ] `SENTRY_ENVIRONMENT=production`
- [ ] Тестовое событие отправлено
- [ ] Алерты настроены

### Логирование

- [ ] Логи пишутся в файлы
- [ ] Log rotation настроен
- [ ] Централизованное логирование (опционально)
- [ ] `LOG_CHAT_ID` настроен для уведомлений
- [ ] Типы уведомлений настроены (`LOG_NEW_USERS`, `LOG_PAYMENTS` и т.д.)

## Производительность

### Оптимизация

- [ ] Redis кэширование включено
- [ ] `REDIS_TTL` настроен оптимально
- [ ] Database connection pool настроен
- [ ] Индексы БД созданы для частых запросов
- [ ] Статические файлы кэшируются

### Масштабирование

- [ ] Horizontal scaling возможен (stateless приложение)
- [ ] Load balancer настроен (если несколько инстансов)
- [ ] Auto-scaling настроен (для Kubernetes)
- [ ] Resource limits установлены

## Резервное копирование

### Автоматические бэкапы

- [ ] Ежедневные бэкапы PostgreSQL настроены
- [ ] Бэкапы Redis настроены (опционально)
- [ ] Бэкапы конфигурации настроены
- [ ] Retention policy: минимум 7 дней
- [ ] Бэкапы хранятся в безопасном месте
- [ ] Тестовое восстановление проведено

### Disaster Recovery

- [ ] План восстановления документирован
- [ ] RTO (Recovery Time Objective) определен
- [ ] RPO (Recovery Point Objective) определен
- [ ] Процедура восстановления протестирована

## Тестирование

### Функциональное тестирование

- [ ] Регистрация нового пользователя работает
- [ ] Триал активация работает
- [ ] Платежи через все провайдеры работают
- [ ] Webhook'и обрабатываются корректно
- [ ] Реферальная система работает
- [ ] Промокоды работают
- [ ] Уведомления отправляются

### Нагрузочное тестирование

- [ ] Система протестирована под нагрузкой
- [ ] Bottleneck'и идентифицированы
- [ ] Максимальная пропускная способность известна
- [ ] Graceful degradation работает

### Мониторинг тестирования

- [ ] Health checks работают
- [ ] Метрики собираются корректно
- [ ] Алерты срабатывают при проблемах
- [ ] Логи пишутся корректно

## Документация

### Техническая документация

- [ ] README.md актуален
- [ ] API документация доступна
- [ ] Deployment guide актуален
- [ ] Operations guide актуален
- [ ] Troubleshooting guide создан

### Операционная документация

- [ ] Runbook создан
- [ ] Контакты команды документированы
- [ ] Escalation процедуры определены
- [ ] On-call rotation настроен (если применимо)

## Compliance и Legal

### Данные пользователей

- [ ] GDPR compliance (если применимо)
- [ ] Privacy policy опубликована
- [ ] Terms of service опубликованы
- [ ] Согласие пользователей получено
- [ ] Процедура удаления данных определена

### Финансовые операции

- [ ] Чеки отправляются (для РФ - 54-ФЗ)
- [ ] Налоговая отчетность настроена
- [ ] Договоры с платежными системами подписаны

## Pre-launch Checklist

### За неделю до запуска

- [ ] Все тесты пройдены
- [ ] Документация завершена
- [ ] Команда обучена
- [ ] Мониторинг настроен
- [ ] Бэкапы работают

### За день до запуска

- [ ] Финальное тестирование проведено
- [ ] Все системы в статусе "healthy"
- [ ] Команда в режиме готовности
- [ ] Rollback план готов

### В день запуска

- [ ] Финальная проверка конфигурации
- [ ] Мониторинг активен
- [ ] Команда на связи
- [ ] Пользователи уведомлены (если применимо)

### После запуска

- [ ] Мониторинг первых пользователей
- [ ] Проверка всех критических путей
- [ ] Анализ метрик
- [ ] Сбор обратной связи

## Post-launch Monitoring

### Первые 24 часа

- [ ] Непрерывный мониторинг метрик
- [ ] Проверка логов каждый час
- [ ] Проверка алертов
- [ ] Анализ пользовательской активности

### Первая неделя

- [ ] Ежедневный анализ метрик
- [ ] Проверка производительности
- [ ] Анализ ошибок
- [ ] Оптимизация на основе данных

### Первый месяц

- [ ] Еженедельный performance review
- [ ] Анализ трендов
- [ ] Планирование оптимизаций
- [ ] Обновление документации

## Continuous Improvement

### Регулярные задачи

- [ ] Еженедельный анализ метрик
- [ ] Ежемесячный security audit
- [ ] Квартальный disaster recovery drill
- [ ] Регулярное обновление зависимостей

### Оптимизация

- [ ] Мониторинг slow queries
- [ ] Оптимизация индексов БД
- [ ] Анализ использования кэша
- [ ] Профилирование приложения

## Emergency Contacts

```
Команда разработки:
- Tech Lead: [имя] - [контакт]
- DevOps: [имя] - [контакт]
- Backend Dev: [имя] - [контакт]

Внешние сервисы:
- Хостинг провайдер: [контакт]
- YooKassa support: [контакт]
- Panel support: [контакт]

Escalation:
1. On-call engineer
2. Tech Lead
3. CTO
```

## Rollback Plan

### Критерии для rollback

- Критические ошибки влияющие на >10% пользователей
- Потеря данных
- Недоступность платежей
- Security breach

### Процедура rollback

```bash
# 1. Остановка текущей версии
docker-compose down

# 2. Откат кода
git checkout <previous-version>

# 3. Откат миграций
docker-compose run --rm bot alembic downgrade <revision>

# 4. Запуск предыдущей версии
docker-compose up -d

# 5. Проверка
docker-compose logs -f bot
```

## Дополнительные ресурсы

- [Deployment Overview](./README.md)
- [Docker Deployment](./docker.md)
- [Kubernetes Deployment](./kubernetes.md)
- [Operations Guide](../operations/README.md)
- [Troubleshooting](../operations/troubleshooting.md)